<html>

<head>
    <link rel="shortcut icon" type="image/png" href="../frame/src/img/game-development.png" />
    <title>Flapy - GameDevelop</title>
</head>

<body>
    <canvas id=gc></canvas>
    <script src=../frame/src/js/gameFrame.js></script>
    <link rel=stylesheet href=../frame/src/css/main.css charset="utf-8">
    <script>
        var game = new Game("gc", 800, 600, true);
        game.control.setStep(13);
        game.canvas.setBackgroundImage(game.addElement(game.ELEMENT.IMAGE, "background.png", game.canvas.width * 2, game.canvas.height, 0, 0));
        game.canvas.backgroundImage.setXSpeed(-0.3);
        game.canvas.canvas.addEventListener('click', handlemouseClick);
        setInterval(() => game.draw(drawing), 1000 / 60);

        var walls = [];
        var wallsInterval;
        var square = 70;
        var points = 0;
        var gap = 70;
        var wallWidth = 20;
        var loseState = false;
        // var bird = game.addElement(game.ELEMENT.RECT, "red", square, square, 150, 250);
        var bird = game.addElement(game.ELEMENT.IMAGE, "bird.png", square, square, 150, 250);
        var background2 = game.addElement(game.ELEMENT.IMAGE, "background.png", game.canvas.width * 2, game.canvas.height, game.canvas.width, 0);
        var pointsCounter = game.addElement(game.ELEMENT.TEXT, "white", 35, points, 50, 50);
			

        bird.setGravity(0.2);
        bird.setRotate(true);
        background2.setXSpeed(-0.3);

        reset();
        var drawing = function () {
            if(!wallsInterval) wallsInterval = setInterval(() => {
                if (game.state == game.STATE.PLAY) randomWall();
            }, 1000 * 3);

            loopBackground();
            printWalls();
            bird.move('y');

            if (game.control.y != 0) {
                bird.y += game.control.y;
                bird.setGravitySpeed(bird.gravity);
               bird.setAngle(-0.56);
            }
            else bird.setAngle(bird.angle+(1 * Math.PI / 180));
            

            pointsCounter.print();
            bird.print();
            
        };

        function printWalls(){
            try{
                for (var i in walls) {
                    if (!walls[i]) continue;
                    walls[i].move('x');
                    walls[i].print();
                    if (bird.collide(walls[i])) lose();
                    if (walls[parseInt(i)+1] && bird.collide({x:walls[i].x, y:(walls[i].y+walls[i].height), width:walls[i].width, height: (walls[parseInt(i)+1].y - (walls[i].y+walls[i].height))})){
                        points++;
                        pointsCounter.setText(points);
                    }
                    if (walls[i].x == -1 * walls[i].width){
                        // walls.splice(i, 1);
                        // walls.shift();
                        game.removeElement(walls[i]);
                        // i --; 
                    }
                }
            }catch(err){
                console.debug("err",err);
            }
        }

        function randomWall() {
            var wallUpHeight = randomValue(100, game.canvas.height - (square*2) - gap - wallWidth);
            var wallDownY = wallUpHeight+(square*2)+gap;
            var wallUp = game.addElement(game.ELEMENT.RECT, "yellow", wallWidth, wallUpHeight, game.canvas.width - 20, 0);
            var wallDown = game.addElement(game.ELEMENT.RECT, "yellow", wallWidth, game.canvas.height - wallDownY, game.canvas.width - 20, wallDownY);
            wallUp.setXSpeed(-2);
            wallDown.setXSpeed(-2);
            walls.push(wallUp);
            walls.push(wallDown);        
        }

        function randomValue(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function loopBackground() {
            game.canvas.backgroundImage.move('x');
            background2.move('x');
            if (game.canvas.backgroundImage.x == -1 * game.canvas.width) {
                game.canvas.backgroundImage.x = game.canvas.width;
            }
            if (background2.x == -1 * game.canvas.width * 2) {
                background2.x = game.canvas.width;
            }
            background2.print();
        }
        function lose(){
            loseState = true;
            game.pause();

        }
        function reset() {
            game.canvas.clear();
            game.canvas.print();
            bird.setX(150);
            bird.setY(250);
            game.canvas.backgroundImage.setX(0);
            game.canvas.backgroundImage.setY(0);
            background2.setX(game.canvas.width);
            background2.setY(0);
            points = 0;
            pointsCounter.setText(points);
            for (var i in walls) if (walls[i]) game.removeElement(walls[i]);
            walls = [];
            randomWall();
            if(wallsInterval){
                clearInterval(wallsInterval);
                wallsInterval = null;
            }
        }
        function handlemouseClick(){
            if(loseState) reset();	
		}
    </script>
</body>

</html>