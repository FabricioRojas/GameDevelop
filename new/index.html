<html>
	<head>
        <link rel="shortcut icon" type="image/png" href="../frame/src/img/game-development.png"/>
	</head>
	<body>
		<canvas id=gc></canvas>
        <script src=../frame/src/js/gameFrame.js></script>
        <link rel=stylesheet href=../frame/src/css/main.css charset="utf-8">
        <script>
            var game = new Game("gc", 800, 600);
            game.control.setStep(10);
            game.canvas.setSolidBordersX(true);
            game.canvas.setSolidBordersY(true);
			setInterval(() => game.draw(drawing), 1000/60);

            var gameStarted = false;
            var brickWidth = 80;
            var brickHeight = 30;
            var bricks = [];
            var lives = 3;
            var ballSpeed = 5;
            
            generateBlocks(4, 7, 20, brickWidth, brickHeight);

            var paddle = game.addElement(game.ELEMENT.RECT, "white", 100, 10, 350, 550);
            var ball = game.addElement(game.ELEMENT.RECT, "white", 10, 10, 395, 540);
            var brickCounter = game.addElement(game.ELEMENT.TEXT, "white", 35, bricks.length, 760, 50);
            var livesCounter = game.addElement(game.ELEMENT.TEXT, "white", 35, lives, 30, 50);
            var winText = game.addElement(game.ELEMENT.TEXT, "white", 50,"Stage cleared!", 300, 300);
            var loseText = game.addElement(game.ELEMENT.TEXT, "white", 50,"You lose!", 300, 300);
           
            paddle.addListener("keydown", keydown);
            paddle.setIsSolid(true);
           
            ball.setXSpeed(0);
            ball.setYSpeed(0);
            ball.setIsSolid(true);
            
			var drawing = function(){
                ball.print();
                paddle.print();
                brickCounter.print();
                livesCounter.print();
                
                ball.move('x');
                ball.move('y');
                paddle.x += game.control.x;

                hitBottom();
                
                ballPaddleCollision(ball.collide(paddle));
                for(var i in bricks){
                    bricks[i].print();
                    ballBrickCollision(ball.collide(bricks[i]),bricks[i], i);
                }
            };

            function ballBrickCollision(collided, brick, index){
                if(!collided || !gameStarted) return;

                bricks.splice(index, 1);
                game.removeElement(brick);
                brickCounter.setText(bricks.length);
                brickCounter.print();
                if(bricks.length == 0) win();
                
                // TODO: Improve brick collision
                ball.setYSpeed(ball.ySpeed*-1);
            }
            
            function hitBottom(){
                
                if(ball.y < game.canvas.height - ball.height) return;

                lives--;
                livesCounter.setText(lives);
                livesCounter.print();
                ball.setXSpeed(0);
                ball.setYSpeed(0);
                ball.setX(395);
                ball.setY(540);
                paddle.setX(350);
                paddle.setY(550);
                gameStarted = false;

                if(lives == 0) lose();
            }

            function lose(){
                game.canvas.clear();
                game.canvas.print();
                loseText.print();
                game.pause();
            }

            function win(){
                game.canvas.clear();
                game.canvas.print();
                winText.print();
                game.pause();
            }

            function ballPaddleCollision(collided){
                if(!collided || !gameStarted) return;
                if(game.control.x < 0 && ball.xSpeed > 0) ball.setXSpeed(-ballSpeed);
                if(game.control.x > 0 && ball.xSpeed < 0) ball.setXSpeed(ballSpeed);
                ball.setYSpeed(-ballSpeed);
            }

            function moveBall(){
                if(gameStarted) return;
                if(game.control.x < 0) ball.setXSpeed(-ballSpeed);
                if(game.control.x > 0) ball.setXSpeed(ballSpeed);
                ball.setYSpeed(-ballSpeed);
                gameStarted = true;
            }

            function generateBlocks(rows, columns, separation, brickWidth, brickHeight){
                bricks = [];
                var bricksSize = ((brickWidth+separation)*columns)-separation;
                var bricksStart = (game.canvas.width-bricksSize)/2;
                var yStart = 70;

                var bricksX = bricksStart;
                for(var i=0;i<rows; i++){
                    
                    for(var j=0;j<columns; j++){
                        bricks.push(game.addElement(game.ELEMENT.RECT, "white", brickWidth, brickHeight, bricksX, yStart))
                        bricksX += brickWidth+separation;
                    }
                    bricksX = bricksStart;
                    yStart += brickHeight+separation;
                }
            }            

			/* Custom listeners */
			function keydown(){
                moveBall();
            }
		</script>
    </body>
</html>