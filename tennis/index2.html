<html>
    <head>
        <link rel="shortcut icon" type="image/png" href="../frame/src/img/game-development.png"/>
    </head>
    <body>
        <canvas id=gc></canvas>
        <script src=../frame/src/js/gameFrame.js></script>
		<link rel=stylesheet href=../frame/src/css/main.css charset="utf-8">
		<script>
			var game = new Game("gc", 800, 600);
			game.control.setStep(30);
			setInterval(() => game.draw(drawing), 1000/30);

			var square = 12;
			var score1Val = 0,score2Val = 0;
			var showingWinScreen = true;
			var winningScore = 10;

			var ball = game.addElement(game.ELEMENT.RECT, "white", square, square, game.canvas.width/2-(square/2), game.canvas.height/2-(square/2));
			var paddle1 = game.addElement(game.ELEMENT.RECT, "white", 10, 100, 15, 50);
			var paddle2 = game.addElement(game.ELEMENT.RECT, "white", 10, 100, game.canvas.width-paddle1.width*2, 40);
			var score1 = game.addElement(game.ELEMENT.TEXT, "white", 20, score1Val, 150, 80);
			var score2 = game.addElement(game.ELEMENT.TEXT, "white", 20, score2Val,  game.canvas.width - score1.x, 80);
			var winMessage = game.addElement(game.ELEMENT.TEXT, "white", 30, "",  game.canvas.width/2, game.canvas.height/2);
			var readyMessage = game.addElement(game.ELEMENT.TEXT, "white", 30, "Ready?",  game.canvas.width/2, game.canvas.height/2);
			var clickMessage = game.addElement(game.ELEMENT.TEXT, "white", 15, "Click to start",  game.canvas.width/2, game.canvas.height/2+50);
			
			var randm = Math.random() * 1.5;
			ball.setXSpeed(7);
			ball.setYSpeed(Math.floor((Math.random() * 2)) ? randm : -randm);

			var drawing = function(){
				if(showingWinScreen){
					if(score1Val == winningScore){
						 winMessage.setText("Player 1 wins");
						 winMessage.print();
					}else if(score2Val == winningScore){
						winMessage.setText("Player 2 wins");
						winMessage.print();
					}else readyMessage.print();
					clickMessage.print();
					return;
				}else{				
					paddle2.y += game.control.y;
					ball.move('x');
					ball.move('y');

					if(isPaddle() == 2){
						ball.setXSpeed(-ball.xSpeed);
						var deltaY = ball.y - (paddle1.y + paddle1.height/2);
						ball.setYSpeed(deltaY * 0.1);
					}else if(ball.x >= (game.canvas.width)){
						score1Val ++;
						score1.setText(score1Val);
						ballReset();
					}

					if(isPaddle() == 1){
						ball.setXSpeed(-ball.xSpeed);
						var deltaY = ball.y - (paddle2.y + paddle2.height/2);
						ball.setYSpeed(deltaY * 0.1);
					}else if(ball.x <= 0){
						score2Val ++;
						score2.setText(score2Val);
						ballReset();
					}

					if(ball.y < 0 || ball.y > game.canvas.height) ball.setYSpeed(-ball.ySpeed);

					ball.print();
					paddle1.print();
					paddle2.print();
					score1.print();
					score2.print();
				}
			};

			function isPaddle(){
				var a = paddle1.y + paddle1.height;
				var b = paddle2.y + paddle2.height;
				
				if(ball.x >= paddle2.x && (ball.y < b && ball.y > paddle2.y)) return 1;
				else if(ball.x <= paddle1.x+ball.width && (ball.y < a && ball.y > paddle1.y)) return 2;
				else return false;
			}			
			function ballReset(){
				if(score1Val >= winningScore || score2Val >= winningScore) showingWinScreen = true;
				
				ball.setX(game.canvas.width/2-(ball.width/2));
				ball.setY(game.canvas.height/2-(ball.width/2));
				//ballSpeedX = -ballSpeedX;
				var randNum = Math.random() * 1.5;
				ballSpeedY = Math.floor((Math.random() * 2)) ? randNum : -randNum;
			}
			function handlemouseClick(){
				if(showingWinScreen){
					score1Val = 0,score2Val = 0;
					score1.setText(score1Val);
					score2.setText(score2Val);
					ball.setX(game.canvas.width/2-(ball.width/2));
					ball.setY(game.canvas.height/2-(ball.height/2));
					showingWinScreen = false;
				}
			}
			/* Custom Listeners */
			// document.addEventListener("keydown", keyPush);
			game.canvas.canvas.addEventListener('click', handlemouseClick);
			game.canvas.canvas.addEventListener('mousemove', 
				function(e){
					var mousePos = getMousePosition(e);
					paddle1.y = mousePos.y;
				}
			);
			function getMousePosition(e){
				var rect = game.canvas.canvas.getBoundingClientRect();
				var root = document.documentElement;
				var mouseX = e.clientX - rect.left - root.scrollLeft;
				var mouseY = e.clientY - rect.top - root.scrollTop - paddle1.height/2;
				return { x:mouseX, y:mouseY}
			}
			function keyPush(evt) {
				switch(evt.keyCode) {
					case game.KEY.UP:
						paddle2.y -= 30;
						break;
					case game.KEY.DOWN:
						paddle2.y += 30;
						break;
				}
			}
		</script>
    </body>
</html>